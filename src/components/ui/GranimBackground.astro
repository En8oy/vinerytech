---
// Componente para fondo animado con Granim.js
---

<div class="granim-wrapper">
  <canvas id="granim-canvas"></canvas>
</div>

<style>
  .granim-wrapper {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    min-height: 100vh;
    z-index: 0;
    pointer-events: none;
    /* Fallback background - siempre visible */
    background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #1e1b4b 100%);
  }

  #granim-canvas {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    display: block;
  }
</style>

<script>
  import Granim from 'granim';

  let granimInstance: Granim | null = null;

  function initGranim() {
    const canvas = document.getElementById('granim-canvas');

    if (canvas) {
      // Destruir instancia anterior si existe
      if (granimInstance) {
        granimInstance.destroy();
        granimInstance = null;
      }

      try {
        granimInstance = new Granim({
          element: '#granim-canvas',
          direction: 'diagonal',
          isPausedWhenNotInView: true,
          opacity: [1, 1],
          states: {
            'default-state': {
              gradients: [
                [
                  { color: '#020617', pos: 0 },
                  { color: '#0f172a', pos: 0.5 },
                  { color: '#1e1b4b', pos: 1 },
                ],
                [
                  { color: '#0a0a0a', pos: 0 },
                  { color: '#0c1929', pos: 0.5 },
                  { color: '#020617', pos: 1 },
                ],
                [
                  { color: '#030712', pos: 0 },
                  { color: '#1e1b4b', pos: 0.5 },
                  { color: '#0f172a', pos: 1 },
                ],
                [
                  { color: '#0f0f23', pos: 0 },
                  { color: '#0c1929', pos: 0.5 },
                  { color: '#020617', pos: 1 },
                ],
              ],
              transitionSpeed: 8000,
              loop: true,
            },
          },
        });
      } catch (error) {
        console.error('Error al inicializar Granim:', error);
      }
    }
  }

  // Inicializar en carga inicial
  document.addEventListener('DOMContentLoaded', initGranim);

  // Reinicializar después de View Transitions (navegación cliente)
  document.addEventListener('astro:page-load', initGranim);

  // Limpiar antes de navegación
  document.addEventListener('astro:before-swap', () => {
    if (granimInstance) {
      granimInstance.destroy();
      granimInstance = null;
    }
  });
</script>
